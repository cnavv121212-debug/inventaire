<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventaire Maintenance</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; background: white; border-radius: 15px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden; }
        .header { background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%); color: white; padding: 30px; text-align: center; position: relative; }
        .header h1 { font-size: 2em; margin-bottom: 10px; }
        .sync-indicator { position: absolute; top: 20px; right: 30px; display: flex; align-items: center; gap: 10px; background: rgba(255,255,255,0.1); padding: 10px 20px; border-radius: 25px; backdrop-filter: blur(10px); }
        .sync-dot { width: 12px; height: 12px; border-radius: 50%; background: #48bb78; animation: pulse 2s infinite; }
        .sync-dot.syncing { background: #4299e1; animation: spin 1s linear infinite; }
        .sync-dot.error { background: #f56565; animation: none; }
        .sync-text { color: white; font-size: 14px; font-weight: 600; }
        .sync-time { color: rgba(255,255,255,0.7); font-size: 12px; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .main-tabs { display: flex; background: #1a202c; border-bottom: 3px solid #667eea; }
        .main-tab { flex: 1; padding: 20px; cursor: pointer; color: #a0aec0; font-weight: 700; font-size: 1.1em; border: none; background: none; transition: all 0.3s; text-align: center; }
        .main-tab:hover { background: #2d3748; color: white; }
        .main-tab.active { background: #667eea; color: white; }
        .main-content { display: none; }
        .main-content.active { display: block; }
        .controls { padding: 25px; background: #f7fafc; border-bottom: 2px solid #e2e8f0; display: flex; gap: 15px; flex-wrap: wrap; align-items: center; }
        .filter-group { display: flex; gap: 10px; align-items: center; flex: 1; min-width: 250px; }
        .filter-group label { font-weight: 600; color: #2d3748; }
        select, input { padding: 10px 15px; border: 2px solid #cbd5e0; border-radius: 8px; font-size: 14px; flex: 1; transition: all 0.3s; }
        select:focus, input:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102,126,234,0.1); }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .btn-primary { background: #667eea; color: white; }
        .btn-primary:hover { background: #5568d3; transform: translateY(-2px); }
        .btn-success { background: #48bb78; color: white; }
        .btn-success:hover { background: #38a169; }
        .btn-warning { background: #ed8936; color: white; }
        .btn-warning:hover { background: #dd6b20; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; padding: 25px; background: #edf2f7; }
        .stat-card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center; transition: transform 0.3s; }
        .stat-card:hover { transform: translateY(-5px); }
        .stat-value { font-size: 2em; font-weight: bold; color: #667eea; }
        .stat-label { color: #718096; margin-top: 5px; font-size: 0.9em; }
        .table-container { padding: 25px; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; background: white; }
        thead { background: #2d3748; color: white; }
        th { padding: 15px; text-align: left; font-weight: 600; }
        td { padding: 12px 15px; border-bottom: 1px solid #e2e8f0; }
        tbody tr { transition: background 0.2s; }
        tbody tr:hover { background: #f7fafc; }
        .badge { display: inline-block; padding: 5px 12px; border-radius: 20px; font-size: 0.85em; font-weight: 600; }
        .badge-cvc { background: #bee3f8; color: #2c5282; }
        .badge-elec { background: #feebc8; color: #c05621; }
        .badge-plomb { background: #c6f6d5; color: #22543d; }
        .badge-divers { background: #e2e8f0; color: #2d3748; }
        .stock-low { color: #f56565; font-weight: bold; }
        .stock-medium { color: #ed8936; font-weight: bold; }
        .stock-good { color: #48bb78; font-weight: bold; }
        .btn-small { padding: 5px 10px; font-size: 12px; border: none; border-radius: 5px; cursor: pointer; margin: 0 2px; }
        .btn-add { background: #48bb78; color: white; }
        .btn-remove { background: #f56565; color: white; }
        .btn-delete { background: #e53e3e; color: white; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .modal-content { background: white; margin: 5% auto; padding: 30px; border-radius: 15px; width: 90%; max-width: 600px; }
        .modal-header { display: flex; justify-content: space-between; margin-bottom: 20px; }
        .close { font-size: 28px; cursor: pointer; color: #718096; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; }
        .form-group input, .form-group select { width: 100%; }
        @media (max-width: 768px) { .sync-indicator { position: relative; top: auto; right: auto; margin: 15px auto 0; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ“‹ Inventaire Maintenance</h1>
            <p>Synchronisation temps rÃ©el</p>
            <div class="sync-indicator" id="syncIndicator">
                <div class="sync-dot" id="syncDot"></div>
                <div>
                    <div class="sync-text" id="syncText">ConnectÃ©</div>
                    <div class="sync-time" id="syncTime">--:--</div>
                </div>
            </div>
        </div>

        <div class="main-tabs">
            <button class="main-tab active" onclick="switchTab('principal')">ðŸ“¦ Inventaire</button>
            <button class="main-tab" onclick="switchTab('sites')">ðŸš› Sites</button>
            <button class="main-tab" onclick="switchTab('outils')">ðŸ”§ Outils</button>
        </div>

        <div id="principal" class="main-content active">
            <div class="controls">
                <div class="filter-group">
                    <label>Recherche:</label>
                    <input type="text" id="searchPrincipal" placeholder="Rechercher..." oninput="render()">
                </div>
                <button class="btn btn-primary" onclick="addArticle('principal')">+ Article</button>
                <button class="btn btn-success" onclick="exportExcel()">ðŸ“Š Export</button>
            </div>
            <div class="stats">
                <div class="stat-card"><div class="stat-value" id="totalPrincipal">0</div><div class="stat-label">Articles</div></div>
                <div class="stat-card"><div class="stat-value" id="lowPrincipal">0</div><div class="stat-label">Stock Faible</div></div>
            </div>
            <div class="table-container">
                <table>
                    <thead><tr><th>RÃ©f</th><th>DÃ©signation</th><th>MÃ©tier</th><th>Stock</th><th>Min</th><th>Actions</th></tr></thead>
                    <tbody id="tablePrincipal"></tbody>
                </table>
            </div>
        </div>

        <div id="sites" class="main-content">
            <div class="controls">
                <select id="filterSite" onchange="render()"><option value="all">Tous les sites</option></select>
                <input type="text" id="searchSites" placeholder="Rechercher..." oninput="render()">
                <button class="btn btn-primary" onclick="addSite()">+ Site</button>
                <button class="btn btn-success" onclick="exportExcel()">ðŸ“Š Export</button>
            </div>
            <div class="stats">
                <div class="stat-card"><div class="stat-value" id="totalSites">0</div><div class="stat-label">Articles</div></div>
                <div class="stat-card"><div class="stat-value" id="nbSites">0</div><div class="stat-label">Sites</div></div>
            </div>
            <div class="table-container">
                <table>
                    <thead><tr><th>Site</th><th>RÃ©f</th><th>DÃ©signation</th><th>MÃ©tier</th><th>Stock</th><th>Actions</th></tr></thead>
                    <tbody id="tableSites"></tbody>
                </table>
            </div>
        </div>

        <div id="outils" class="main-content">
            <div class="controls">
                <input type="text" id="searchOutils" placeholder="Rechercher..." oninput="render()">
                <button class="btn btn-primary" onclick="addOutil()">+ Outil</button>
                <button class="btn btn-success" onclick="exportExcel()">ðŸ“Š Export</button>
            </div>
            <div class="stats">
                <div class="stat-card"><div class="stat-value" id="totalOutils">0</div><div class="stat-label">Outils</div></div>
                <div class="stat-card"><div class="stat-value" id="affectes">0</div><div class="stat-label">AffectÃ©s</div></div>
            </div>
            <div class="table-container">
                <table>
                    <thead><tr><th>Outil</th><th>CatÃ©gorie</th><th>Technicien</th><th>Ã‰tat</th><th>Actions</th></tr></thead>
                    <tbody id="tableOutils"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Ajouter</h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div id="modalBody"></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        const URL_SCRIPT = 'https://script.google.com/macros/s/AKfycbx54c3YQfz4K5xvTdUG9Pj99gjn_1U-wp9hDRgeLv4E0DxnXFNUsJQuNtabO_bFIUsL/exec';
        let data = {inventoryPrincipal: [], sites: {}, outils: [], metiers: [], techniciens: []};
        let currentTab = 'principal';

        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.main-tab, .main-content').forEach(el => el.classList.remove('active'));
            document.querySelector(`[onclick="switchTab('${tab}')"]`).classList.add('active');
            document.getElementById(tab).classList.add('active');
            render();
        }

        function updateSync(status, time) {
            const dot = document.getElementById('syncDot');
            const text = document.getElementById('syncText');
            const timeEl = document.getElementById('syncTime');
            dot.className = 'sync-dot ' + (status === 'syncing' ? 'syncing' : status === 'error' ? 'error' : '');
            text.textContent = status === 'syncing' ? 'Sync...' : status === 'error' ? 'Erreur' : 'ConnectÃ©';
            if (time) timeEl.textContent = time;
        }

        async function load() {
            try {
                updateSync('syncing');
                const res = await fetch(URL_SCRIPT + '?action=load');
                const json = await res.json();
                if (json.error) throw new Error(json.error);
                data = json;
                updateSiteFilter();
                render();
                updateSync('ok', new Date().toLocaleTimeString('fr', {hour: '2-digit', minute: '2-digit'}));
            } catch(e) {
                console.error(e);
                updateSync('error');
            }
        }

        async function save() {
            try {
                updateSync('syncing');
                await fetch(URL_SCRIPT, {
                    method: 'POST',
                    headers: {'Content-Type': 'text/plain'},
                    body: JSON.stringify(data)
                });
                updateSync('ok', new Date().toLocaleTimeString('fr', {hour: '2-digit', minute: '2-digit'}));
            } catch(e) {
                console.error(e);
                updateSync('error');
            }
        }

        function updateSiteFilter() {
            const select = document.getElementById('filterSite');
            select.innerHTML = '<option value="all">Tous</option>' + Object.keys(data.sites).map(s => `<option value="${s}">${s}</option>`).join('');
        }

        function render() {
            if (currentTab === 'principal') renderPrincipal();
            else if (currentTab === 'sites') renderSites();
            else renderOutils();
        }

        function renderPrincipal() {
            const search = document.getElementById('searchPrincipal').value.toLowerCase();
            const filtered = data.inventoryPrincipal.filter(i => i.designation.toLowerCase().includes(search) || i.ref.toLowerCase().includes(search));
            document.getElementById('tablePrincipal').innerHTML = filtered.map((item, idx) => `
                <tr>
                    <td><strong>${item.ref}</strong></td>
                    <td>${item.designation}</td>
                    <td><span class="badge badge-divers">${item.metier}</span></td>
                    <td class="${item.stock < item.stockMin ? 'stock-low' : 'stock-good'}">${item.stock}</td>
                    <td>${item.stockMin}</td>
                    <td>
                        <button class="btn-small btn-add" onclick="modStock('principal', ${idx}, 1)">+</button>
                        <button class="btn-small btn-remove" onclick="modStock('principal', ${idx}, -1)">-</button>
                        <button class="btn-small btn-delete" onclick="delItem('principal', ${idx})">Ã—</button>
                    </td>
                </tr>
            `).join('');
            document.getElementById('totalPrincipal').textContent = data.inventoryPrincipal.length;
            document.getElementById('lowPrincipal').textContent = data.inventoryPrincipal.filter(i => i.stock < i.stockMin).length;
        }

        function renderSites() {
            const filter = document.getElementById('filterSite').value;
            const search = document.getElementById('searchSites').value.toLowerCase();
            let items = [];
            Object.keys(data.sites).forEach(site => {
                if (filter === 'all' || filter === site) {
                    data.sites[site].forEach((item, idx) => {
                        if (item.designation.toLowerCase().includes(search) || item.ref.toLowerCase().includes(search)) {
                            items.push({site, item, idx});
                        }
                    });
                }
            });
            document.getElementById('tableSites').innerHTML = items.map(({site, item, idx}) => `
                <tr>
                    <td><strong>${site}</strong></td>
                    <td>${item.ref}</td>
                    <td>${item.designation}</td>
                    <td><span class="badge badge-divers">${item.metier}</span></td>
                    <td class="${item.stock < item.stockMin ? 'stock-low' : 'stock-good'}">${item.stock}</td>
                    <td>
                        <button class="btn-small btn-add" onclick="modSiteStock('${site}', ${idx}, 1)">+</button>
                        <button class="btn-small btn-remove" onclick="modSiteStock('${site}', ${idx}, -1)">-</button>
                        <button class="btn-small btn-delete" onclick="delSiteItem('${site}', ${idx})">Ã—</button>
                    </td>
                </tr>
            `).join('');
            let total = 0;
            Object.values(data.sites).forEach(site => total += site.length);
            document.getElementById('totalSites').textContent = total;
            document.getElementById('nbSites').textContent = Object.keys(data.sites).length;
        }

        function renderOutils() {
            const search = document.getElementById('searchOutils').value.toLowerCase();
            const filtered = data.outils.filter(o => o.nom.toLowerCase().includes(search));
            document.getElementById('tableOutils').innerHTML = filtered.map((outil, idx) => `
                <tr>
                    <td><strong>${outil.nom}</strong></td>
                    <td>${outil.categorie}</td>
                    <td>${outil.technicien || '<em>Non affectÃ©</em>'}</td>
                    <td class="${outil.etat === 'Bon' ? 'stock-good' : 'stock-medium'}">${outil.etat}</td>
                    <td>
                        <button class="btn-small btn-delete" onclick="delOutil(${idx})">Ã—</button>
                    </td>
                </tr>
            `).join('');
            document.getElementById('totalOutils').textContent = data.outils.length;
            document.getElementById('affectes').textContent = data.outils.filter(o => o.technicien).length;
        }

        function modStock(type, idx, qty) {
            data.inventoryPrincipal[idx].stock = Math.max(0, data.inventoryPrincipal[idx].stock + qty);
            render();
            save();
        }

        function modSiteStock(site, idx, qty) {
            data.sites[site][idx].stock = Math.max(0, data.sites[site][idx].stock + qty);
            render();
            save();
        }

        function delItem(type, idx) {
            if (confirm('Supprimer?')) {
                data.inventoryPrincipal.splice(idx, 1);
                render();
                save();
            }
        }

        function delSiteItem(site, idx) {
            if (confirm('Supprimer?')) {
                data.sites[site].splice(idx, 1);
                render();
                save();
            }
        }

        function delOutil(idx) {
            if (confirm('Supprimer?')) {
                data.outils.splice(idx, 1);
                render();
                save();
            }
        }

        function addArticle(type) {
            const modal = document.getElementById('modal');
            document.getElementById('modalTitle').textContent = 'Ajouter Article';
            document.getElementById('modalBody').innerHTML = `
                <div class="form-group"><label>RÃ©fÃ©rence</label><input id="ref" required></div>
                <div class="form-group"><label>DÃ©signation</label><input id="designation" required></div>
                <div class="form-group"><label>MÃ©tier</label><input id="metier" value="Divers"></div>
                <div class="form-group"><label>Stock</label><input id="stock" type="number" value="0"></div>
                <div class="form-group"><label>Stock Min</label><input id="stockMin" type="number" value="5"></div>
                <div class="form-group"><label>UnitÃ©</label><input id="unit" value="pcs"></div>
                <button class="btn btn-primary" onclick="saveArticle('${type}')">Ajouter</button>
            `;
            modal.style.display = 'block';
        }

        function saveArticle(type) {
            const item = {
                ref: document.getElementById('ref').value,
                designation: document.getElementById('designation').value,
                metier: document.getElementById('metier').value,
                stock: parseInt(document.getElementById('stock').value),
                stockMin: parseInt(document.getElementById('stockMin').value),
                unit: document.getElementById('unit').value
            };
            data.inventoryPrincipal.push(item);
            closeModal();
            render();
            save();
        }

        function addSite() {
            const name = prompt('Nom du site:');
            if (name && !data.sites[name]) {
                data.sites[name] = [];
                updateSiteFilter();
                render();
                save();
            }
        }

        function addOutil() {
            const name = prompt('Nom de l\'outil:');
            if (name) {
                data.outils.push({nom: name, categorie: 'Autre', technicien: '', etat: 'Bon', serie: '', dateAttribution: ''});
                render();
                save();
            }
        }

        function closeModal() {
            document.getElementById('modal').style.display = 'none';
        }

        function exportExcel() {
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(data.inventoryPrincipal.map(i => ({
                RÃ©fÃ©rence: i.ref, DÃ©signation: i.designation, MÃ©tier: i.metier, Stock: i.stock, Min: i.stockMin, UnitÃ©: i.unit
            })));
            XLSX.utils.book_append_sheet(wb, ws, 'Inventaire');
            XLSX.writeFile(wb, 'inventaire.xlsx');
        }

        window.onclick = e => { if (e.target.id === 'modal') closeModal(); };
        load();
        setInterval(load, 30000);
    </script>
</body>
</html>